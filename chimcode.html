<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chim Code - C Sequence Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Courier+Prime:wght@400;700&family=Source+Code+Pro:wght@400;500;700&family=VT323&display=swap" rel="stylesheet">
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-color: #111827; /* gray-900 */
            --panel-bg-color: #1f2937; /* gray-800 */
            --border-color: #374151; /* gray-700 */
            --text-color: #e5e7eb; /* gray-200 */
            --text-muted-color: #9ca3af; /* gray-400 */
            --accent-color: #22d3ee; /* cyan-400 */
            --accent-hover-color: #67e8f9; /* cyan-300 */
            --hint-color: #6ee7b7; /* emerald-300 */
            --star-color: #facc15; /* yellow-400 */
            --success-color: #059669; /* Emerald-600 */
            --error-color: #dc2626; /* Red-600 */
            --info-btn-bg: #4f46e5; /* indigo-600 */
            --info-btn-hover-bg: #6366f1; /* indigo-500 */
            --library-btn-bg: #6d28d9; /* violet-700 */
            --library-btn-hover-bg: #7c3aed; /* violet-600 */
            --price-color: #f59e0b; /* amber-500 */
            --money-price-color: #a3e635; /* lime-400 */
            --blur-amount: 3px;
            --appstore-blue: #007aff; /* iOS Blue */
            --appstore-blue-hover: #005ecb;
            /* Glassy Button Styles */
            --glass-bg-color: color-mix(in srgb, var(--panel-bg-color), transparent 70%); /* Semi-transparent background */
            --glass-border-color: color-mix(in srgb, var(--border-color), transparent 30%);
            --glass-hover-bg: color-mix(in srgb, var(--text-muted-color), transparent 80%);
            --glass-blur-amount: 8px; /* Blur intensity */
            /* Custom Theme Additions */
            --header-btn-text-color: white; /* Default for star/library buttons */
            /* Font Variable */
            --main-font-family: 'Roboto Mono', monospace; /* Default Font */
        }
        /* Example Theme 1: Matrix */
        .theme-matrix {
            --bg-color: #000000; --panel-bg-color: #0D0208; --border-color: #003B00;
            --text-color: #00FF00; --text-muted-color: #008F11; --accent-color: #00FF00;
            --accent-hover-color: #80FF80; --hint-color: #00FF00; --star-color: #39FF14;
            --success-color: #008F11; --error-color: #7F0000; --info-btn-bg: #008F11;
            --info-btn-hover-bg: #00FF00; --library-btn-bg: #006400; --library-btn-hover-bg: #008000;
            --price-color: #39FF14; --money-price-color: #80FF80;
            --appstore-blue: #00A800; --appstore-blue-hover: #007500;
            --glass-bg-color: color-mix(in srgb, var(--panel-bg-color), transparent 70%);
            --glass-border-color: color-mix(in srgb, var(--border-color), transparent 30%);
            --glass-hover-bg: color-mix(in srgb, var(--text-muted-color), transparent 80%);
            --header-btn-text-color: #00FF00;
        }
            /* Example Theme 2: Solarized Light */
        .theme-solarized {
            --bg-color: #fdf6e3; --panel-bg-color: #eee8d5; --border-color: #93a1a1;
            --text-color: #586e75; --text-muted-color: #839496; --accent-color: #268bd2;
            --accent-hover-color: #2aa198; --hint-color: #859900; --star-color: #b58900;
            --success-color: #859900; --error-color: #dc322f; --info-btn-bg: #6c71c4;
            --info-btn-hover-bg: #d33682; --library-btn-bg: #cb4b16; --library-btn-hover-bg: #dc322f;
            --price-color: #b58900; --money-price-color: #859900;
            --appstore-blue: #268bd2; --appstore-blue-hover: #1a5f90;
            --glass-bg-color: color-mix(in srgb, var(--panel-bg-color), transparent 60%); /* Adjust alpha for light theme */
            --glass-border-color: color-mix(in srgb, var(--border-color), transparent 30%);
            --glass-hover-bg: color-mix(in srgb, var(--text-muted-color), transparent 80%);
            --header-btn-text-color: #586e75;
        }

        /* Global Styles */
        body {
            font-family: var(--main-font-family); /* Use Font Variable */
            background-color: var(--bg-color);
            color: var(--text-color); overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease, font-family 0.3s ease; /* Added font transition */
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--panel-bg-color); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted-color); }

        /* Code Area & Attempts Counter */
        #code-display-container { /* New wrapper */
            position: relative;
            flex-grow: 1;
            width: 100%;
            min-height: 0;
            background-color: var(--panel-bg-color); /* Match code area bg */
            border: 1px solid var(--border-color); /* Match code area border */
            border-radius: 8px; /* Match code area radius */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.4); /* Match code area shadow */
            display: flex; /* To make area fill container */
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        #code-display-area {
            font-family: var(--main-font-family);
            font-size: 0.9rem; line-height: 1.6; color: var(--text-color);
            white-space: pre; overflow-y: auto;
            width: 100%; /* Fill wrapper */
            height: 100%; /* Fill wrapper */
            padding: 12px; /* Equivalent to old p-3 */
            box-sizing: border-box;
            background-color: transparent; /* Inherit from container */
            border: none; /* Remove duplicate border */
            box-shadow: none; /* Remove duplicate shadow */
            border-radius: 0; /* Not needed */
            transition: color 0.3s ease, font-family 0.3s ease; /* Keep relevant transitions */
        }
        .explanation-comment { color: var(--hint-color); font-style: italic; }
        #attempts-counter {
            position: absolute;
            bottom: 8px; /* Adjust as needed */
            right: 12px; /* Adjust as needed */
            font-size: 0.75rem; /* text-xs */
            color: var(--text-muted-color);
            pointer-events: none; /* Don't interfere with scrolling etc. */
            z-index: 10; /* Ensure it's above code */
            transition: color 0.3s ease;
        }


        /* Hint Area */
        #hint-container {
            display: flex; align-items: center; gap: 10px;
            background-color: color-mix(in srgb, var(--panel-bg-color), transparent 50%);
            border: 1px dashed var(--border-color); border-radius: 6px; padding: 8px 12px;
            min-height: 3em; margin-bottom: 10px;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        #hint-text {
            flex-grow: 1; color: var(--hint-color); font-style: italic; font-size: 0.85rem;
            line-height: 1.5; white-space: pre-wrap; transition: filter 0.3s ease, color 0.3s ease;
        }
        #hint-text.blurred { filter: blur(var(--blur-amount)); user-select: none; cursor: default; }

        /* --- Hint Button Style --- */
        #reveal-hint-btn {
            background-color: var(--appstore-blue); color: white; border: none;
            border-radius: 999px; /* Pill shape */
            padding: 5px 15px; /* Match appstore button padding */
            font-size: 0.9em; /* Match appstore button font size */
            font-weight: 600; /* Match appstore button font weight */
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, color 0.3s ease;
            line-height: 1.4; /* Match appstore button line height */
            display: inline-flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            min-width: 90px; /* Match appstore button min width */
        }
        #reveal-hint-btn:hover:not(:disabled) { background-color: var(--appstore-blue-hover); }
        #reveal-hint-btn:active:not(:disabled) { transform: scale(0.96); }
        #reveal-hint-btn:disabled {
            background-color: color-mix(in srgb, var(--appstore-blue), var(--panel-bg-color) 60%);
            color: color-mix(in srgb, white, var(--panel-bg-color) 40%);
            cursor: not-allowed; opacity: 0.7;
        }
        #reveal-hint-btn .star-icon { /* Style for star inside hint button */
            color: var(--star-color); font-size: 1.2em; margin-right: 3px; line-height: 1; transition: color 0.3s ease;
        }
        #reveal-hint-btn.hidden { display: none; }
        /* --- End Hint Button Style --- */


        /* Option Buttons */
        .option-btn-wrapper { position: relative; }
        .option-btn {
            font-family: var(--main-font-family); /* Use Font Variable */
            background-color: var(--border-color); border: 1px solid var(--text-muted-color);
            color: var(--text-color); padding: 12px 10px; padding-right: 30px; border-radius: 6px;
            font-weight: 500; transition: all 0.2s ease; text-align: left; font-size: 0.85rem;
            line-height: 1.4; width: 100%; white-space: pre;
            cursor: pointer; overflow: hidden; text-overflow: ellipsis;
        }
        .option-btn:hover:not(:disabled) { background-color: var(--text-muted-color); border-color: var(--accent-color); transform: translateY(-1px); }
        .option-btn:active:not(:disabled) { transform: translateY(0px); }
        .option-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Info Button (on incorrect options) */
        .info-btn {
            position: absolute; right: 5px; top: 50%; transform: translateY(-50%);
            background-color: var(--info-btn-bg); color: white; border: none; border-radius: 50%;
            width: 22px; height: 22px; font-size: 14px; font-weight: bold; line-height: 22px;
            text-align: center; cursor: pointer; transition: background-color 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .info-btn:hover { background-color: var(--info-btn-hover-bg); }

        /* --- Header --- */
        #main-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color); padding-bottom: 0.75rem; margin-bottom: 0.5rem;
        }
        .header-left { display: flex; align-items: baseline; gap: 0.5rem; }
        .header-right { display: flex; align-items: center; gap: 0.75rem; }

        #main-title { font-size: 1.25rem; font-weight: bold; color: var(--accent-color); transition: color 0.3s ease; }
        .language-indicator {
            font-size: 1.4em; font-weight: bold; color: var(--accent-color);
            opacity: 0.3; line-height: 1; transition: color 0.3s ease;
        }

        /* --- Glassy Header Buttons w/ Blur --- */
        .glassy-header-btn {
            background-color: var(--glass-bg-color);
            backdrop-filter: blur(var(--glass-blur-amount));
            -webkit-backdrop-filter: blur(var(--glass-blur-amount));
            border: 1px solid var(--glass-border-color);
            border-radius: 20px; padding: 6px 15px;
            display: inline-flex; align-items: center; justify-content: center;
            color: var(--header-btn-text-color); /* Use new variable */
            font-weight: 500;
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.3s ease, transform 0.1s ease;
            cursor: pointer; text-shadow: none; box-shadow: none;
        }
        @supports (backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px)) {}
        .glassy-header-btn:hover {
            background-color: var(--glass-hover-bg); border-color: var(--text-muted-color);
            color: var(--header-btn-text-color); /* Maintain text color on hover */
        }
        .glassy-header-btn:active {
            transform: scale(0.98);
            background-color: color-mix(in srgb, var(--glass-hover-bg), black 10%);
        }
        #level-display-btn { padding: 5px 10px; color: var(--accent-hover-color); font-size: 1rem; transition: color 0.3s ease; }
        #level-display-btn:hover { color: var(--accent-color); }
        #library-btn { font-size: 0.9rem; padding: 6px 12px; }
        #star-display-wrapper { min-width: 70px; }
        #star-count { margin: 0; display: flex; align-items: baseline; gap: 5px; }
        #star-count .star-icon { color: var(--star-color); font-size: 1.3em; line-height: 1; display: inline-block; vertical-align: middle; transition: color 0.3s ease;}
        #star-count .star-number { vertical-align: middle; }
        /* --- End Glassy Header Buttons --- */

        /* --- Star Animations --- */
        @keyframes star-jump { /* No changes needed */
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-8px) scale(1.1); }
        }
        .star-jump-animation { animation: star-jump 0.35s ease-in-out; }
        @keyframes star-flash-red-bg { /* Flash border/background */
            0%, 100% {
                background-color: var(--glass-bg-color); border-color: var(--glass-border-color);
            }
            50% {
                background-color: color-mix(in srgb, var(--error-color), transparent 70%);
                border-color: var(--error-color);
            }
        }
        .star-flash-red-animation { animation: star-flash-red-bg 0.4s ease-in-out; }
        /* --- End Star Styling & Animations --- */


        /* Generic Buttons (Endgame, Level Select) */
        .endgame-btn, .level-select-btn {
            background-color: var(--info-btn-bg); border: 1px solid var(--info-btn-hover-bg); color: white;
            padding: 8px 16px; border-radius: 6px; font-weight: 500;
            transition: background-color 0.2s ease; margin: 5px;
            cursor: pointer; text-align: center;
        }
        .endgame-btn:hover, .level-select-btn:hover { background-color: var(--info-btn-hover-bg); }
        .level-select-btn:disabled {
            background-color: var(--border-color); border-color: var(--text-muted-color);
            color: var(--text-muted-color); cursor: not-allowed; opacity: 0.7;
        }
        .level-select-btn { width: 100%; margin: 5px 0; }
        .level-select-btn span { display: block; font-size: 0.8em; color: var(--text-muted-color); }

        /* --- App Store Purchase Buttons --- */
        .purchase-buttons-container {
            display: flex; flex-direction: row; gap: 10px; /* Side-by-side */
            /* Default to center, specific overrides can change this */
            justify-content: center;
            align-items: center;
            min-width: 180px; /* Adjusted slightly */
        }
        /* Override for theme store items (excluding single button / buy stars) */
        #theme-store-modal .theme-item:not(.single-button-item):not(.buy-stars-item) .purchase-buttons-container {
            justify-content: flex-end;
        }
        /* Specific override for buy stars / single button items */
        .buy-stars-item .purchase-buttons-container,
        .single-button-item .purchase-buttons-container {
            justify-content: flex-end; /* Keep these right-aligned */
        }


        .appstore-purchase-btn {
            background-color: var(--appstore-blue); color: white; border: none;
            border-radius: 999px; padding: 5px 15px; font-size: 0.9em; font-weight: 600;
            cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease, color 0.3s ease;
            min-width: 90px; text-align: center; line-height: 1.4;
            display: inline-flex; align-items: center; justify-content: center;
            flex-shrink: 0; /* Prevent buttons from shrinking too much */
        }
        .appstore-purchase-btn:hover:not(:disabled) { background-color: var(--appstore-blue-hover); }
        .appstore-purchase-btn:active:not(:disabled) { transform: scale(0.96); }
        .appstore-purchase-btn:disabled {
            background-color: color-mix(in srgb, var(--appstore-blue), var(--panel-bg-color) 60%);
            color: color-mix(in srgb, white, var(--panel-bg-color) 40%);
            cursor: not-allowed; opacity: 0.7;
        }
        .appstore-purchase-btn .star-icon {
            color: var(--star-color); font-size: 1.2em; margin-right: 3px; line-height: 1; transition: color 0.3s ease;
        }
        /* Applied/Current State Text */
        .status-text-container {
            display: flex; align-items: center; justify-content: center; /* Center the status text too */
            /* Take up the space normally used by buttons */
            min-width: 180px; /* Match adjusted button container width */
        }
        /* Override for theme store items needing right alignment */
        #theme-store-modal .theme-item .status-text-container {
            justify-content: flex-end;
        }


        .status-text {
            background-color: var(--success-color); color: white;
            border-radius: 999px; padding: 5px 15px; font-size: 0.9em; font-weight: 600;
            min-width: 90px; text-align: center; line-height: 1.4;
            display: inline-block; transition: background-color 0.3s ease;
        }


        /* Modal styles */
        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease; backdrop-filter: blur(2px);
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--panel-bg-color); color: var(--text-color);
            padding: 25px; border-radius: 8px; border: 1px solid var(--border-color);
            max-width: 600px; width: 90%; position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4); transform: scale(0.95);
            transition: transform 0.3s ease, background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
            max-height: 80vh; overflow-y: auto;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-close-btn {
            position: absolute; top: 10px; right: 10px; background: transparent; border: none;
            color: var(--text-muted-color); font-size: 24px; line-height: 1; cursor: pointer;
        }
        .modal-close-btn:hover { color: var(--text-color); }

        /* Feedback Overlay Styles */
        .feedback-overlay {
            position: fixed; inset: 0; z-index: 100; opacity: 0; visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
            pointer-events: none;
        }
        .feedback-overlay.visible { opacity: 1; visibility: visible; }
        .feedback-overlay.overlay-green { background-color: color-mix(in srgb, var(--success-color), transparent 80%); }
        .feedback-overlay.overlay-red { background-color: color-mix(in srgb, var(--error-color), transparent 80%); }

        /* Info Modal Feedback Area */
        #feedback-area { display: none; margin-top: 15px; }
        #feedback-text {
            width: 100%; background-color: var(--bg-color); color: var(--text-color);
            border: 1px solid var(--border-color); border-radius: 4px; padding: 8px;
            min-height: 60px; font-size: 0.9em; margin-bottom: 10px;
        }
        #feedback-submit-btn { /* Uses .endgame-btn style */
            background-color: var(--info-btn-bg); border: 1px solid var(--info-btn-hover-bg); color: white;
            padding: 8px 16px; border-radius: 6px; font-weight: 500;
            transition: background-color 0.2s ease; margin: 5px;
            cursor: pointer; text-align: center;
        }
        #feedback-submit-btn:hover { background-color: var(--info-btn-hover-bg); }
        #feedback-confirmation { color: var(--hint-color); font-style: italic; font-size: 0.9em; }

        /* Theme Store Specific Styles */
        .theme-item {
            border: 1px solid var(--border-color); padding: 10px 15px;
            margin-bottom: 10px; border-radius: 8px; display: flex;
            justify-content: space-between; align-items: center;
            background-color: color-mix(in srgb, var(--panel-bg-color), transparent 30%);
            min-height: 55px;
        }
        .theme-info { flex-grow: 1; margin-right: 15px; }
        .theme-name { font-weight: bold; font-size: 1.0em; color: var(--text-color); }
        /* Buy Stars Item Specific Style */
        /* .buy-stars-item .purchase-buttons-container handled globally */
        /* Single Button Item Specific Style */
        /* .single-button-item .purchase-buttons-container handled globally */


        /* Library Modal Specific Styles */
        #library-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Wider cards for side-by-side buttons */
            gap: 15px;
        }
        .language-card {
            background-color: var(--bg-color); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 15px; text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex; flex-direction: column; justify-content: space-between;
            min-height: 100px;
        }
        .language-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .language-name { font-weight: bold; font-size: 1.1em; margin-bottom: 10px; color: var(--accent-color); }
        .language-card.current-language { border-color: var(--accent-color); box-shadow: 0 0 10px color-mix(in srgb, var(--accent-color), transparent 70%); }
        .language-card.current-language .language-name { color: var(--accent-hover-color); }
        .language-card .purchase-buttons-container {
            margin-top: auto;
            justify-content: center; /* Explicitly center buttons in language cards */
        }
        .language-card .status-text-container {
            justify-content: center; /* Also center 'Current' text */
        }


        /* Level Select Modal Styles */
        #level-list { margin-top: 15px; max-height: 50vh; overflow-y: auto; padding-right: 10px; }
        .level-select-item { border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px; }
        .level-select-item:last-child { border-bottom: none; margin-bottom: 0; }

        /* Custom Theme Modal Styles */
        #custom-theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .color-picker-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: var(--bg-color); /* Match panel bg */
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        .color-picker-item label {
            font-size: 0.85em;
            color: var(--text-muted-color);
            flex-shrink: 0;
            width: 100px; /* Align labels */
        }
        .color-picker-item input[type="color"] {
            width: 40px; /* Adjust size */
            height: 30px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            padding: 0; /* Remove default padding */
            background-color: transparent; /* Ensure picker swatch is visible */
        }
        /* Style the color picker swatch itself */
        .color-picker-item input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        .color-picker-item input[type="color"]::-webkit-color-swatch { border: none; border-radius: 3px; }
        .color-picker-item input[type="color"]::-moz-color-swatch { border: none; border-radius: 3px; }

        /* Font Selection in Custom Modal */
        #font-selection-area {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        #font-selection-area label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-muted-color);
            font-size: 0.9em;
            font-weight: 500;
        }
        #font-select-dropdown {
            width: 100%;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--main-font-family); /* Show current font in dropdown */
            font-size: 0.9em;
            cursor: pointer;
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }
        #font-select-dropdown:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        #font-select-dropdown:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: var(--panel-bg-color);
        }
        #font-unlock-message {
            font-size: 0.85em;
            color: var(--error-color);
            margin-top: 5px;
            text-align: center;
        }

    </style>
</head>
<body class="h-screen flex flex-col p-4 md:p-6 gap-4">

    <div id="main-header">
        <div class="header-left">
            <h1 id="main-title">Chim Code</h1>
            <span class="language-indicator">C</span>
        </div>
        <div style="flex-grow: 1;"></div> <div class="header-right">
            <button id="level-display-btn" class="glassy-header-btn" title="Select Level">
                <span id="level-text">Level 1</span>
            </button>
            <button id="library-btn" class="glassy-header-btn" title="Open Language Library">Library</button>
            <div id="star-display-wrapper" class="glassy-header-btn" title="Open Theme Store">
                <p id="star-count">
                    <span class="star-icon">★</span> <span class="star-number">0</span>
                </p>
            </div>
        </div>
    </div>

    <div id="code-display-container" class="relative flex-grow w-full min-h-0">
        <div id="code-display-area" class="w-full h-full p-3">
            </div>
        <div id="attempts-counter" class="absolute bottom-2 right-3 text-xs" style="color: var(--text-muted-color); pointer-events: none;">
            Attempts: 1
        </div>
    </div>


    <div id="hint-container">
        <span id="hint-text" class="blurred"></span>
        <button id="reveal-hint-btn">Hint: <span class="star-icon">★</span> 1</button>
    </div>

    <div id="interaction-area" class="grid grid-cols-1 md:grid-cols-3 gap-3 pt-3 border-t" style="border-color: var(--border-color);">
        </div>

    <div id="info-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="modal-close" class="modal-close-btn">&times;</button>
            <h3 class="text-lg font-semibold mb-3" style="color: var(--accent-color);">Why is this incorrect?</h3>
            <p id="modal-reason" class="mb-4"></p>
            <button id="flag-feedback-btn" class="endgame-btn text-sm py-1 px-3">Disagree? Flag for Review</button>
            <div id="feedback-area">
                <textarea id="feedback-text" placeholder="Explain why you think this option might be correct (optional)..."></textarea>
                <button id="feedback-submit-btn" class="endgame-btn">Submit Feedback</button>
                <p id="feedback-confirmation" class="mt-2"></p>
            </div>
        </div>
    </div>

    <div id="theme-store-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="theme-modal-close" class="modal-close-btn">&times;</button>
            <h3 class="text-lg font-semibold mb-4" style="color: var(--accent-color);">Theme Store</h3>
            <p class="mb-4 text-sm" style="color: var(--text-muted-color);">Use stars (★) or purchase themes to customize your experience!</p>

            <div class="theme-item" data-item-identifier="default">
                <div class="theme-info"> <div class="theme-name">Default Theme</div> </div>
                <div class="purchase-buttons-container">
                    <div class="status-text-container"> <span class="status-text">Applied</span> </div>
                </div>
            </div>
            <div class="theme-item" data-item-identifier="theme-matrix" data-star-price="200" data-money-price="2.99">
                <div class="theme-info"> <div class="theme-name">Matrix Theme</div> </div>
                <div class="purchase-buttons-container">
                    </div>
                <div class="status-text-container" style="display: none;"></div>
            </div>
            <div class="theme-item" data-item-identifier="theme-solarized" data-star-price="200" data-money-price="2.99">
                <div class="theme-info"> <div class="theme-name">Solarized Light Theme</div> </div>
                <div class="purchase-buttons-container">
                    </div>
                <div class="status-text-container" style="display: none;"></div>
            </div>
            <div class="theme-item" data-item-identifier="color-orange" data-star-price="200" data-money-price="2.99">
                <div class="theme-info"> <div class="theme-name">Accent Color: Orange</div> </div>
                <div class="purchase-buttons-container">
                    </div>
                <div class="status-text-container" style="display: none;"></div>
            </div>
            <div class="theme-item" data-item-identifier="custom-theme" data-star-price="1000" data-money-price="4.99">
                <div class="theme-info"> <div class="theme-name">Custom Theme</div> </div>
                <div class="purchase-buttons-container">
                    </div>
                <div class="status-text-container" style="display: none;"></div>
            </div>
            <div class="theme-item single-button-item" data-item-identifier="change-font" data-star-price="20">
                <div class="theme-info"> <div class="theme-name">Change Font</div> </div>
                <div class="purchase-buttons-container">
                    </div>
                <div class="status-text-container" style="display: none;"></div>
            </div>
            <div class="theme-item buy-stars-item" data-item-identifier="buy-stars">
                <div class="theme-info"> <div class="theme-name">Get 1000 Stars</div> </div>
                <div class="purchase-buttons-container">
                    <button data-action="buy-stars" data-amount="1000" data-money-price="4.99" class="appstore-purchase-btn">$4.99</button>
                </div>
                <div class="status-text-container" style="display: none;"></div> </div>
            <p id="store-message" class="text-center mt-4 text-sm" style="color: var(--error-color);"></p>
        </div>
    </div>

    <div id="library-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="library-modal-close" class="modal-close-btn">&times;</button>
            <h3 class="text-lg font-semibold mb-4" style="color: var(--accent-color);">Language Library</h3>
            <p class="mb-4 text-sm" style="color: var(--text-muted-color);">Select a language to start learning. Currently only 'C' is available.</p>
            <div id="library-grid">
                </div>
            <p id="library-message" class="text-center mt-4 text-sm" style="color: var(--error-color);"></p>
        </div>
    </div>

    <div id="level-select-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="level-select-modal-close" class="modal-close-btn">&times;</button>
            <h3 class="text-lg font-semibold mb-4" style="color: var(--accent-color);">Select Level</h3>
            <div id="level-list">
                </div>
        </div>
    </div>

    <div id="custom-theme-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="custom-theme-modal-close" class="modal-close-btn">&times;</button>
            <h3 class="text-lg font-semibold mb-4" style="color: var(--accent-color);">Customize Theme</h3>
            <p class="mb-4 text-sm" style="color: var(--text-muted-color);">Select colors and font for different UI elements. Changes apply immediately.</p>

            <div id="custom-theme-grid">
                </div>

            <div id="font-selection-area">
                <label for="font-select-dropdown">Select Font:</label>
                <select id="font-select-dropdown" disabled>
                    </select>
                <p id="font-unlock-message" style="display: none;">Unlock "Change Font" in the Theme Store (★ 20) to enable selection.</p>
            </div>

            <div class="text-center mt-4">
                <button id="apply-custom-theme-btn" class="endgame-btn">Apply & Close</button>
                <button id="reset-custom-theme-btn" class="endgame-btn" style="background-color: var(--error-color); border-color: color-mix(in srgb, var(--error-color), black 20%);">Reset to Defaults</button>
            </div>
        </div>
    </div>


    <div id="feedback-overlay" class="feedback-overlay"></div>

    <script src="c_levels.js"></script>

    <script>
        // --- Game Data ---
        // The 'challengesData' constant is now available from c_levels.js
        // The large const challengesData = [...] array has been removed from here.

        // Example of how you might access it (your actual game logic will be more complex):
        // This check can be part of your game initialization logic.
        if (typeof challengesData !== 'undefined' && challengesData && challengesData.length > 0) {
            console.log("Successfully loaded challengesData from c_levels.js");
            // console.log("First challenge goal:", challengesData[0].goal); // Example access
        } else {
            console.error("challengesData is not loaded or is empty! Check c_levels.js.");
            // Potentially display an error to the user or halt game initialization
        }

        const availableLanguages = [
            { id: 'c', name: 'C', priceStars: 0, priceMoney: null, available: true },
            { id: 'cpp', name: 'C++', priceStars: 1000, priceMoney: '4.99', available: false },
            { id: 'csharp', name: 'C#', priceStars: 1000, priceMoney: '4.99', available: false },
            { id: 'python', name: 'Python', priceStars: 1000, priceMoney: '4.99', available: false },
            { id: 'java', name: 'Java', priceStars: 1000, priceMoney: '4.99', available: false },
            { id: 'javascript', name: 'JavaScript', priceStars: 1000, priceMoney: '4.99', available: false },
            { id: 'html', name: 'HTML', priceStars: 1000, priceMoney: '4.99', available: false },
            { id: 'css', name: 'CSS', priceStars: 1000, priceMoney: '4.99', available: false },
            { id: 'php', name: 'PHP', priceStars: 1000, priceMoney: '4.99', available: false },
            { id: 'swift', name: 'Swift', priceStars: 1000, priceMoney: '4.99', available: false },
            { id: 'kotlin', name: 'Kotlin', priceStars: 1000, priceMoney: '4.99', available: false },
            { id: 'rust', name: 'Rust', priceStars: 1000, priceMoney: '4.99', available: false },
            { id: 'r', name: 'R', priceStars: 1000, priceMoney: '4.99', available: false },
            { id: 'ruby', name: 'Ruby', priceStars: 1000, priceMoney: '4.99', available: false },
        ];

        const availableFonts = {
            'Roboto Mono': "'Roboto Mono', monospace",
            'Source Code Pro': "'Source Code Pro', monospace",
            'Courier Prime': "'Courier Prime', monospace",
            'VT323': "'VT323', monospace" // Pixel font
        };
        const defaultFontFamily = availableFonts['Roboto Mono'];

        const customThemeProperties = {
            '--bg-color': 'Background',
            '--panel-bg-color': 'Panel Background',
            '--border-color': 'Borders',
            '--text-color': 'Primary Text',
            '--text-muted-color': 'Muted Text',
            '--accent-color': 'Accent / Logo',
            '--accent-hover-color': 'Accent Hover',
            '--hint-color': 'Hint Text',
            '--star-color': 'Star Icon',
            '--header-btn-text-color': 'Header Button Text',
            '--success-color': 'Success Messages',
            '--error-color': 'Error Messages',
            '--appstore-blue': 'Purchase Buttons'
        };
        let defaultThemeValues = {};

        // --- Game State ---
        let currentLevelIndex = 0;
        let currentStep = 0;
        let starCount = 0;
        let constructedCode = '';
        let optionsLocked = false;
        let feedbackTimeout = null;
        let incorrectChoiceData = null;
        let previousStarCountForAnimation = 0;
        let hintRevealed = false; // Still track if hint button was clicked for cost/display
        let unlockedThemes = {};
        let unlockedLanguages = {};
        let unlockedFeatures = {};
        let currentCustomColors = {};
        let currentFontFamily = defaultFontFamily;
        // --- NEW State for Star Glitch Fix & Attempts ---
        let initialStarsForLevelAttempt = 0;
        let levelAttempts = {}; // Stores attempts per level index, e.g., { 0: 1, 1: 2 }
        let levelInProgress = false; // Flag to check if refresh happened mid-level
        let levelCompletedThisSession = {}; // Track completion to prevent re-rewarding stars on simple replay without refresh {levelIndex: true}


        // --- DOM Elements ---
        const levelDisplayBtn = document.getElementById('level-display-btn');
        const levelTextSpan = document.getElementById('level-text');
        const starDisplay = document.getElementById('star-count');
        const starNumberSpan = starDisplay.querySelector('.star-number');
        const starDisplayWrapper = document.getElementById('star-display-wrapper');
        const libraryBtn = document.getElementById('library-btn');
        const codeDisplayArea = document.getElementById('code-display-area');
        const interactionArea = document.getElementById('interaction-area');
        const hintContainer = document.getElementById('hint-container');
        const hintText = document.getElementById('hint-text');
        const revealHintBtn = document.getElementById('reveal-hint-btn');
        const infoModal = document.getElementById('info-modal');
        const modalReason = document.getElementById('modal-reason');
        const modalCloseBtn = document.getElementById('modal-close');
        const themeStoreModal = document.getElementById('theme-store-modal');
        const themeStoreContent = themeStoreModal.querySelector('.modal-content');
        const themeModalCloseBtn = document.getElementById('theme-modal-close');
        const libraryModal = document.getElementById('library-modal');
        const libraryModalContent = libraryModal.querySelector('.modal-content');
        const libraryModalCloseBtn = document.getElementById('library-modal-close');
        const libraryGrid = document.getElementById('library-grid');
        const libraryMessage = document.getElementById('library-message');
        const levelSelectModal = document.getElementById('level-select-modal');
        const levelSelectModalCloseBtn = document.getElementById('level-select-modal-close');
        const levelListContainer = document.getElementById('level-list');
        const customThemeModal = document.getElementById('custom-theme-modal');
        const customThemeModalCloseBtn = document.getElementById('custom-theme-modal-close');
        const customThemeGrid = document.getElementById('custom-theme-grid');
        const applyCustomThemeBtn = document.getElementById('apply-custom-theme-btn');
        const resetCustomThemeBtn = document.getElementById('reset-custom-theme-btn');
        const feedbackOverlay = document.getElementById('feedback-overlay');
        const flagFeedbackBtn = document.getElementById('flag-feedback-btn');
        const feedbackArea = document.getElementById('feedback-area');
        const feedbackTextEl = document.getElementById('feedback-text');
        const feedbackSubmitBtn = document.getElementById('feedback-submit-btn');
        const feedbackConfirmation = document.getElementById('feedback-confirmation');
        const fontSelectionArea = document.getElementById('font-selection-area');
        const fontSelectDropdown = document.getElementById('font-select-dropdown');
        const fontUnlockMessage = document.getElementById('font-unlock-message');
        const attemptsCounter = document.getElementById('attempts-counter'); // New element


        // --- Helper Functions ---
        function shuffleArray(array) { /* ... shuffle ... */
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        function getIndent(level) { return '    '.repeat(level); } // Use 4 spaces for indent
        function getCssVariableValue(varName) {
            const cssVarName = varName.startsWith('--') ? varName : `--${varName}`;
            const value = getComputedStyle(document.documentElement).getPropertyValue(cssVarName).trim();
            return value;
        }
        // MODIFIED: updateStarDisplay no longer saves to sessionStorage
        function updateStarDisplay(animate = false, animationType = 'none') {
            starNumberSpan.textContent = starCount;
            // sessionStorage.setItem('chimCodeStars', starCount.toString()); // REMOVED - save explicitly elsewhere
            starDisplayWrapper.classList.remove('star-jump-animation', 'star-flash-red-animation');
            if (animate) {
                setTimeout(() => {
                    if (animationType === 'gain') {
                        starDisplayWrapper.classList.add('star-jump-animation');
                        setTimeout(() => starDisplayWrapper.classList.remove('star-jump-animation'), 350);
                    } else if (animationType === 'loss') {
                        starDisplayWrapper.classList.add('star-flash-red-animation');
                        setTimeout(() => starDisplayWrapper.classList.remove('star-flash-red-animation'), 400);
                    }
                }, animationType !== 'none' ? 50 : 0);
            }
            // Update buttons dependent on star count
            updateStoreButtons();
            updateLibraryButtons();
            updateHintButtonState();
        }

        // NEW: Function to explicitly save stable star count
        function saveStarCount() {
            sessionStorage.setItem('chimCodeStars', starCount.toString());
            console.log(`Saved star count: ${starCount}`);
        }

        function scrollCodeDisplay() { codeDisplayArea.scrollTop = codeDisplayArea.scrollHeight; }
        function escapeHtml(unsafe) { /* ... escapeHtml ... */
            if (typeof unsafe !== 'string') { return unsafe; }
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // --- Modal Functions ---
        // (showModal, hideModal, event listeners remain mostly the same)
        function showModal(modalElement) { modalElement.classList.add('visible'); }
        function hideModal(modalElement) { modalElement.classList.remove('visible'); }
        modalCloseBtn.addEventListener('click', () => hideModal(infoModal));
        infoModal.addEventListener('click', (event) => { if (event.target === infoModal) hideModal(infoModal); });
        themeModalCloseBtn.addEventListener('click', () => hideModal(themeStoreModal));
        themeStoreModal.addEventListener('click', (event) => { if (event.target === themeStoreModal) hideModal(themeStoreModal); });
        starDisplayWrapper.addEventListener('click', () => {
            updateStoreButtons();
            document.getElementById('store-message').textContent = '';
            showModal(themeStoreModal);
        });
        libraryModalCloseBtn.addEventListener('click', () => hideModal(libraryModal));
        libraryModal.addEventListener('click', (event) => { if (event.target === libraryModal) hideModal(libraryModal); });
        libraryBtn.addEventListener('click', () => {
            populateLibraryGrid();
            updateLibraryButtons();
            libraryMessage.textContent = '';
            showModal(libraryModal);
        });
        levelSelectModalCloseBtn.addEventListener('click', () => hideModal(levelSelectModal));
        levelSelectModal.addEventListener('click', (event) => { if (event.target === levelSelectModal) hideModal(levelSelectModal); });
        levelDisplayBtn.addEventListener('click', () => {
            populateLevelList();
            showModal(levelSelectModal);
        });
        customThemeModalCloseBtn.addEventListener('click', () => {
            applyFont(sessionStorage.getItem('chimCodeFont') || defaultFontFamily);
            hideModal(customThemeModal);
        });
        customThemeModal.addEventListener('click', (event) => {
            if (event.target === customThemeModal) {
                applyFont(sessionStorage.getItem('chimCodeFont') || defaultFontFamily);
                hideModal(customThemeModal);
            }
        });
        function showInfoModal(reason, incorrectData) { /* ... showInfoModal ... */
            modalReason.textContent = reason || "No specific reason provided.";
            incorrectChoiceData = incorrectData;
            feedbackArea.style.display = 'none';
            flagFeedbackBtn.textContent = 'Disagree? Flag for Review';
            flagFeedbackBtn.disabled = false;
            feedbackTextEl.value = '';
            feedbackConfirmation.textContent = '';
            showModal(infoModal);
        }
        function showFeedbackOverlay(type) { /* ... showFeedbackOverlay ... */
            if (feedbackTimeout) { clearTimeout(feedbackTimeout); }
            feedbackOverlay.classList.remove('overlay-green', 'overlay-red', 'visible');
            void feedbackOverlay.offsetWidth; // Reflow
            feedbackOverlay.classList.add(type === 'correct' ? 'overlay-green' : 'overlay-red');
            feedbackOverlay.classList.add('visible');
            feedbackTimeout = setTimeout(() => {
                feedbackOverlay.classList.remove('visible');
                setTimeout(() => {
                    feedbackOverlay.classList.remove('overlay-green', 'overlay-red');
                }, 200);
            }, 400);
        }

        // --- Custom Theme & Font Functions ---
        // (No changes needed in these functions)
        function populateCustomThemeModal() {
            customThemeGrid.innerHTML = '';
            const currentColors = getCurrentThemeValues();
            for (const [cssVar, label] of Object.entries(customThemeProperties)) {
                const item = document.createElement('div');
                item.classList.add('color-picker-item');
                const labelEl = document.createElement('label');
                labelEl.htmlFor = `color-picker-${cssVar}`;
                labelEl.textContent = label;
                const inputEl = document.createElement('input');
                inputEl.type = 'color';
                inputEl.id = `color-picker-${cssVar}`;
                inputEl.dataset.cssVar = cssVar;
                inputEl.value = currentColors[cssVar]?.startsWith('#') ? currentColors[cssVar] : '#ffffff';
                inputEl.addEventListener('input', (event) => {
                    document.documentElement.style.setProperty(cssVar, event.target.value);
                });
                item.appendChild(labelEl);
                item.appendChild(inputEl);
                customThemeGrid.appendChild(item);
            }
            fontSelectDropdown.innerHTML = '';
            const currentSavedFont = sessionStorage.getItem('chimCodeFont') || defaultFontFamily;
            for (const [fontName, fontFamily] of Object.entries(availableFonts)) {
                const option = document.createElement('option');
                option.value = fontFamily;
                option.textContent = fontName;
                option.style.fontFamily = fontFamily;
                if (fontFamily === currentSavedFont) {
                    option.selected = true;
                }
                fontSelectDropdown.appendChild(option);
            }
            const fontChangeUnlocked = unlockedFeatures['change-font'] === true;
            fontSelectDropdown.disabled = !fontChangeUnlocked;
            fontUnlockMessage.style.display = fontChangeUnlocked ? 'none' : 'block';
            showModal(customThemeModal);
        }
        function getCurrentThemeValues() {
            const currentThemeId = sessionStorage.getItem('chimCodeTheme') || 'default';
            let savedCustomColors = {};
            try {
                savedCustomColors = JSON.parse(sessionStorage.getItem('chimCodeCustomColors') || '{}');
            } catch (e) {
                console.error("Error parsing saved custom colors:", e);
                sessionStorage.removeItem('chimCodeCustomColors');
            }
            if (currentThemeId === 'custom-theme' && Object.keys(savedCustomColors).length > 0) {
                return savedCustomColors;
            }
            const computedValues = {};
            for (const cssVar in customThemeProperties) {
                computedValues[cssVar] = getCssVariableValue(cssVar);
            }
            return computedValues;
        }
        function applyCustomColors(colorsObject) {
            for (const [cssVar, colorValue] of Object.entries(colorsObject)) {
                if (colorValue) {
                    document.documentElement.style.setProperty(cssVar, colorValue);
                }
            }
            currentCustomColors = colorsObject;
            sessionStorage.setItem('chimCodeCustomColors', JSON.stringify(colorsObject));
            sessionStorage.setItem('chimCodeTheme', 'custom-theme');
            updateStoreButtons();
        }
        function applyFont(fontFamily) {
            document.documentElement.style.setProperty('--main-font-family', fontFamily);
            currentFontFamily = fontFamily;
            if(fontSelectDropdown) {
                fontSelectDropdown.style.fontFamily = fontFamily;
            }
        }
        function saveFont(fontFamily) {
            sessionStorage.setItem('chimCodeFont', fontFamily);
            applyFont(fontFamily);
        }
        fontSelectDropdown.addEventListener('change', (event) => {
            if (!event.target.disabled) {
                applyFont(event.target.value);
            }
        });
        applyCustomThemeBtn.addEventListener('click', () => {
            const newColors = {};
            customThemeGrid.querySelectorAll('input[type="color"]').forEach(input => {
                newColors[input.dataset.cssVar] = input.value;
            });
            applyCustomColors(newColors);
            if (!fontSelectDropdown.disabled) {
                saveFont(fontSelectDropdown.value);
            }
            document.body.classList.remove('theme-matrix', 'theme-solarized');
            hideModal(customThemeModal);
        });
        resetCustomThemeBtn.addEventListener('click', () => {
            applyCustomColors(defaultThemeValues);
            customThemeGrid.querySelectorAll('input[type="color"]').forEach(input => {
                const cssVar = input.dataset.cssVar;
                input.value = defaultThemeValues[cssVar] || '#ffffff';
            });
            saveFont(defaultFontFamily);
            fontSelectDropdown.value = defaultFontFamily;
            applyFont(defaultFontFamily);
        });

        // --- Theme Functions ---
        // (No changes needed in applyTheme, applyAccentColor)
        function applyTheme(themeId) {
            document.body.classList.remove('theme-matrix', 'theme-solarized');
            if (themeId !== 'custom-theme') {
                for (const cssVar in customThemeProperties) {
                    document.documentElement.style.removeProperty(cssVar);
                }
                sessionStorage.removeItem('chimCodeCustomColors');
                currentCustomColors = {};
            }
            const themeClass = themeId.startsWith('theme-') ? themeId : '';
            if (themeClass) {
                document.body.classList.add(themeClass);
            }
            sessionStorage.setItem('chimCodeTheme', themeId || 'default');
            if (themeId === 'color-orange') {
                applyAccentColor('--accent-color', '#f97316');
                applyAccentColor('--accent-hover-color', '#fb923c');
            } else if (themeId === 'custom-theme') {
                let savedCustom = {};
                try {
                    savedCustom = JSON.parse(sessionStorage.getItem('chimCodeCustomColors') || '{}');
                } catch(e) { console.error("Error parsing custom colors on applyTheme:", e); }
                if (Object.keys(savedCustom).length > 0) {
                    for (const [cssVar, colorValue] of Object.entries(savedCustom)) {
                        if (colorValue) document.documentElement.style.setProperty(cssVar, colorValue);
                    }
                    currentCustomColors = savedCustom;
                } else {
                    console.warn("Custom theme selected but no colors saved. Reverting to default colors.");
                    for (const [cssVar, colorValue] of Object.entries(defaultThemeValues)) {
                        if (colorValue) document.documentElement.style.setProperty(cssVar, colorValue);
                    }
                    currentCustomColors = { ...defaultThemeValues };
                    sessionStorage.setItem('chimCodeCustomColors', JSON.stringify(currentCustomColors));
                }
            }
            updateStoreButtons();
        }
        function applyAccentColor(colorVar, colorValue) {
            document.documentElement.style.setProperty(colorVar, colorValue);
        }


        // --- MODIFIED: loadSessionData ---
        function loadSessionData() {
            defaultThemeValues = {};
            for (const cssVar in customThemeProperties) {
                defaultThemeValues[cssVar] = getCssVariableValue(cssVar);
            }

            // --- Load Game State ---
            let stateNeedsRevert = false;
            let savedInitialStars = 0;
            let savedLevelIndex = 0;

            try {
                // Load permanent unlocks/settings
                unlockedThemes = JSON.parse(sessionStorage.getItem('chimCodeUnlockedThemes') || '{}');
                unlockedLanguages = JSON.parse(sessionStorage.getItem('chimCodeUnlockedLanguages') || '{}');
                unlockedFeatures = JSON.parse(sessionStorage.getItem('chimCodeUnlockedFeatures') || '{}');
                currentCustomColors = JSON.parse(sessionStorage.getItem('chimCodeCustomColors') || '{}');
                levelAttempts = JSON.parse(sessionStorage.getItem('chimCodeLevelAttempts') || '{}');
                levelCompletedThisSession = JSON.parse(sessionStorage.getItem('chimCodeLevelCompleted') || '{}');

                // Load potentially temporary state (related to refresh mid-level)
                levelInProgress = JSON.parse(sessionStorage.getItem('chimCodeLevelInProgress') || 'false');
                savedInitialStars = parseInt(sessionStorage.getItem('chimCodeInitialStars') || '0', 10);
                savedLevelIndex = parseInt(sessionStorage.getItem('chimCodeSavedLevelIndex') || '0', 10);

                // Load last saved star count
                starCount = parseInt(sessionStorage.getItem('chimCodeStars') || '0', 10);
                if (isNaN(starCount)) starCount = 0;

                // Check if refresh happened mid-level
                if (levelInProgress) {
                    console.warn("Level was in progress on refresh. Reverting star count.");
                    starCount = savedInitialStars; // Revert to stars before the interrupted attempt
                    currentLevelIndex = savedLevelIndex; // Ensure we restart the correct level
                    levelInProgress = false; // Reset flag as we are handling the refresh now
                    sessionStorage.setItem('chimCodeLevelInProgress', 'false'); // Update storage
                    stateNeedsRevert = true; // Flag that we reverted
                }

            } catch (e) {
                console.error("Error parsing saved state:", e);
                // Reset everything on error
                unlockedThemes = {}; unlockedLanguages = {}; unlockedFeatures = {}; currentCustomColors = {};
                levelAttempts = {}; levelCompletedThisSession = {};
                starCount = 0; initialStarsForLevelAttempt = 0; levelInProgress = false; currentLevelIndex = 0;
                sessionStorage.clear(); // Clear potentially corrupted storage
            }
            // --- End Load Game State ---


            // Apply theme and font
            const savedThemeId = sessionStorage.getItem('chimCodeTheme') || 'default';
            applyTheme(savedThemeId);
            const savedFont = sessionStorage.getItem('chimCodeFont') || defaultFontFamily;
            applyFont(savedFont);

            // Return the index to start the game at (usually 0 unless refresh happened)
            return stateNeedsRevert ? savedLevelIndex : 0;
        }

        // --- Game Logic Functions ---
        function displayStep() { /* ... displayStep (no changes needed here) ... */
            if (typeof challengesData === 'undefined' || !challengesData[currentLevelIndex]) { // Check challengesData
                console.error("Invalid level index or challengesData not loaded:", currentLevelIndex);
                interactionArea.innerHTML = `<p class="md:col-span-3 text-center text-red-500">Error: Level data not found. Check c_levels.js.</p>`;
                hintText.textContent = '';
                revealHintBtn.classList.add('hidden');
                return;
            }
            const currentChallenge = challengesData[currentLevelIndex];
            if (currentStep >= currentChallenge.sequence.length) {
                endGame();
                return;
            }
            optionsLocked = false;
            hintRevealed = false; // Reset hint revealed status for the new step
            const stepData = currentChallenge.sequence[currentStep];
            const hintContent = stepData.explanation ? `Hint: ${stepData.explanation}` : '';
            hintText.textContent = hintContent;
            if (hintContent) {
                hintText.classList.add('blurred');
                revealHintBtn.classList.remove('hidden');
                updateHintButtonState();
            } else {
                hintText.classList.remove('blurred');
                revealHintBtn.classList.add('hidden');
            }
            const correctOption = { text: stepData.correct, isCorrect: true };
            const distractors = stepData.distractors || [];
            const distractorOptions = distractors.map(d => ({ ...d, isCorrect: false }));
            let allOptions = [correctOption, ...distractorOptions];
            while (allOptions.length < 3 && allOptions.length > 0) {
                if (distractorOptions.length > 0) {
                    allOptions.push({...distractorOptions[0], isCorrect: false});
                } else {
                    allOptions.push({text: "/* Placeholder 1 */", isCorrect: false, reason: "This is a placeholder."});
                    if (allOptions.length < 3) {
                        allOptions.push({text: "/* Placeholder 2 */", isCorrect: false, reason: "This is another placeholder."});
                    }
                }
            }
            allOptions = shuffleArray(allOptions);
            interactionArea.innerHTML = '';
            allOptions.forEach((optionData) => {
                const wrapper = document.createElement('div');
                wrapper.classList.add('option-btn-wrapper');
                const button = document.createElement('button');
                button.classList.add('option-btn');
                button.textContent = getIndent(stepData.indent) + optionData.text;
                button.dataset.correct = optionData.isCorrect;
                if (!optionData.isCorrect && optionData.reason) {
                    button.dataset.reason = optionData.reason;
                    button.dataset.incorrectText = optionData.text;
                }
                button.addEventListener('click', handleOptionClick);
                wrapper.appendChild(button);
                interactionArea.appendChild(wrapper);
            });
        }

        // --- handleOptionClick (MODIFIED) ---
        function handleOptionClick(event) {
            if (optionsLocked) return;
            optionsLocked = true;

            const button = event.target.closest('.option-btn');
            if (!button) return;

            const wrapper = button.parentElement;
            const isCorrect = button.dataset.correct === 'true';
            const reason = button.dataset.reason;
            const incorrectText = button.dataset.incorrectText;
            const currentChallenge = challengesData[currentLevelIndex]; // Assumes challengesData is loaded
            const stepData = currentChallenge.sequence[currentStep];

            interactionArea.querySelectorAll('.info-btn').forEach(btn => btn.remove());
            interactionArea.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);

            previousStarCountForAnimation = starCount; // Track for animation logic

            if (isCorrect) {
                // Only award stars if the level hasn't been completed in this session yet
                if (!levelCompletedThisSession[currentLevelIndex]) {
                    starCount += 3;
                } else {
                    console.log("Level already completed this session, no stars awarded.");
                }
                showFeedbackOverlay('correct');
                // Update display without saving stars yet
                updateStarDisplay(starCount > previousStarCountForAnimation, 'gain');

                // --- MODIFIED: Add explanation as comment WITHOUT "Hint: " ---
                let codeToAdd = '';
                if (stepData.explanation) {
                    // Add the explanation as a C-style comment
                    codeToAdd += getIndent(stepData.indent) + `<span class="explanation-comment">${escapeHtml("// " + stepData.explanation)}</span>\n`;
                }
                // Add the actual correct code line after the potential comment
                const escapedCorrectCode = escapeHtml(stepData.correct);
                codeToAdd += getIndent(stepData.indent) + escapedCorrectCode + '\n';
                constructedCode += codeToAdd;
                // --- END MODIFICATION ---

                codeDisplayArea.innerHTML = constructedCode; // Use innerHTML to render the span
                scrollCodeDisplay();

                setTimeout(() => {
                    currentStep++;
                    displayStep(); // Moves to next step or calls endGame
                }, 300);

            } else { // Incorrect choice
                // Only deduct stars if the level hasn't been completed in this session yet
                if (!levelCompletedThisSession[currentLevelIndex]) {
                    starCount = Math.max(0, starCount - 2);
                } else {
                    console.log("Level already completed this session, no stars deducted.");
                }
                showFeedbackOverlay('incorrect');
                const didLoseStar = starCount < previousStarCountForAnimation;
                // Update display without saving stars yet
                updateStarDisplay(didLoseStar, 'loss');

                if (reason) {
                    const infoBtn = document.createElement('button');
                    infoBtn.classList.add('info-btn');
                    infoBtn.textContent = 'ⓘ';
                    infoBtn.title = "Why is this incorrect?";
                    infoBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showInfoModal(reason, {
                            level: currentLevelIndex + 1,
                            step: currentStep + 1,
                            correct: stepData.correct,
                            incorrect: incorrectText
                        });
                    });
                    wrapper.appendChild(infoBtn);
                }

                setTimeout(() => {
                    interactionArea.querySelectorAll('.option-btn').forEach(btn => {
                        btn.disabled = false;
                    });
                    optionsLocked = false;
                }, 500);
            }
        }

        // --- Hint Button Logic ---
        // MODIFIED: Star deduction only if level not completed
        function updateHintButtonState() {
            const hintCost = 1;
            // Can reveal if have enough stars AND haven't revealed this step yet
            const canReveal = starCount >= hintCost && !hintRevealed;
            revealHintBtn.disabled = !canReveal;

            revealHintBtn.innerHTML = `Hint: <span class="star-icon">★</span> ${hintCost}`;
            if (starCount < hintCost && !hintRevealed) {
                revealHintBtn.innerHTML = `Need <span class="star-icon">★</span> ${hintCost}`;
            }
            // If hint was revealed this step, keep it disabled
            if(hintRevealed) {
                revealHintBtn.disabled = true;
                revealHintBtn.innerHTML = `Hint: <span class="star-icon">★</span> ${hintCost}`;
            }
        }

        revealHintBtn.addEventListener('click', () => {
            const hintCost = 1;
            if (starCount >= hintCost && !hintRevealed) {
                // Only deduct stars if the level hasn't been completed in this session yet
                let didLoseStar = false;
                if (!levelCompletedThisSession[currentLevelIndex]) {
                    previousStarCountForAnimation = starCount;
                    starCount -= hintCost;
                    didLoseStar = true;
                } else {
                    console.log("Level already completed this session, hint revealed for free.");
                }

                // Update display without saving stars yet
                updateStarDisplay(didLoseStar, 'loss');
                hintText.classList.remove('blurred');
                hintRevealed = true; // Mark as revealed *for this step*
                updateHintButtonState(); // Update button state (will disable it)
            }
        });
        // --- End Hint Button Logic ---

        // --- MODIFIED: endGame ---
        function endGame() {
            const isLastLevel = currentLevelIndex >= challengesData.length - 1; // Assumes challengesData is loaded
            hintText.textContent = '';
            revealHintBtn.classList.add('hidden');
            hintContainer.style.display = 'none';

            // Mark level as completed for this session to prevent re-earning stars
            levelCompletedThisSession[currentLevelIndex] = true;
            sessionStorage.setItem('chimCodeLevelCompleted', JSON.stringify(levelCompletedThisSession));

            // Mark level as no longer in progress
            levelInProgress = false;
            sessionStorage.setItem('chimCodeLevelInProgress', 'false');
            sessionStorage.removeItem('chimCodeInitialStars'); // Clean up
            sessionStorage.removeItem('chimCodeSavedLevelIndex'); // Clean up

            // Save the final star count now that the level is complete
            saveStarCount();

            // Display end game options
            interactionArea.innerHTML = `
                <div class="md:col-span-3 text-center py-4">
                    <p class="font-bold text-lg mb-4" style="color: var(--success-color);">
                        Level ${currentLevelIndex + 1} Complete! Final Score: <span class="star-icon">★</span> ${starCount}
                    </p>
                    <button id="restart-btn" class="endgame-btn">Restart Level</button>
                    ${!isLastLevel ? '<button id="next-btn" class="endgame-btn">Next Level</button>' : '<p class="mt-2" style="color: var(--star-color);">All levels complete!</p>'}
                    <button id="level-select-endgame-btn" class="endgame-btn">Select Level</button>
                </div>
            `;

            // --- MODIFIED: Restart Button Logic ---
            document.getElementById('restart-btn')?.addEventListener('click', () => {
                // Calculate net change from the attempt that just finished
                let starChange = starCount - initialStarsForLevelAttempt;
                console.log(`Restarting Level ${currentLevelIndex + 1}. Initial stars for attempt: ${initialStarsForLevelAttempt}, Final stars: ${starCount}, Change: ${starChange}`);

                // Revert the star count
                starCount = initialStarsForLevelAttempt; // Go back to the count before this attempt
                console.log(`Reverted star count to: ${starCount}`);

                // Update display and save the reverted count immediately
                updateStarDisplay();
                saveStarCount();

                // Re-initialize the game for the same level (will increment attempts again)
                initializeGame(currentLevelIndex);
            });

            // --- Next Level Button Logic ---
            if (!isLastLevel) {
                document.getElementById('next-btn')?.addEventListener('click', () => {
                    // Star count is already saved correctly by endGame
                    initializeGame(currentLevelIndex + 1);
                });
            }

            // --- Level Select Button Logic ---
            document.getElementById('level-select-endgame-btn')?.addEventListener('click', () => {
                // Star count is already saved correctly by endGame
                populateLevelList();
                showModal(levelSelectModal);
            });
        }

        // --- Feedback Submission ---
        flagFeedbackBtn.addEventListener('click', () => { /* ... flagFeedbackBtn click ... */
            feedbackArea.style.display = 'block';
            flagFeedbackBtn.textContent = 'Submit Feedback';
            flagFeedbackBtn.disabled = true;
            feedbackConfirmation.textContent = '';
        });
        feedbackSubmitBtn.addEventListener('click', () => { /* ... feedbackSubmitBtn click ... */
            const feedbackContent = feedbackTextEl.value.trim();
            console.log("--- User Feedback Received ---");
            console.log("Context:", incorrectChoiceData || "N/A");
            console.log("Feedback:", feedbackContent || "(No text entered)");
            console.warn("Note: This feedback is logged to the browser console only...");
            feedbackConfirmation.textContent = 'Feedback logged to console. Thank you!';
            feedbackTextEl.value = '';
            setTimeout(() => {
                feedbackArea.style.display = 'none';
                feedbackConfirmation.textContent = '';
                flagFeedbackBtn.disabled = false;
                flagFeedbackBtn.textContent = 'Disagree? Flag for Review';
            }, 3000);
        });


        // --- Store/Library Button State Management ---
        // (MODIFIED for centered language buttons - CSS handles this now)
        function manageItemState(itemElement, isUnlocked, isApplied, isCurrent = false) {
            const btnContainer = itemElement.querySelector('.purchase-buttons-container');
            const statusContainer = itemElement.querySelector('.status-text-container');

            if (!btnContainer || !statusContainer) return;

            const itemIdentifier = itemElement.dataset.itemIdentifier;
            const isLanguageItem = itemElement.closest('#library-modal');

            // Reset visibility
            btnContainer.style.display = 'none';
            statusContainer.style.display = 'none';
            statusContainer.innerHTML = ''; // Clear old status text

            // Handle special items first
            if (itemIdentifier === 'buy-stars') {
                btnContainer.style.display = 'flex';
                btnContainer.style.justifyContent = 'flex-end'; // Ensure right-alignment
                const buyBtn = btnContainer.querySelector('button[data-action="buy-stars"]');
                if (buyBtn) buyBtn.style.display = 'inline-flex';
                return;
            }

            // Handle regular items (Themes, Languages, Features)
            if (isApplied) { // Applied (Themes) or Current (Language)
                statusContainer.style.display = 'flex';
                // CSS now handles alignment (center for lang, right for theme)
                const statusText = document.createElement('span');
                statusText.classList.add('status-text');
                statusText.textContent = isCurrent ? 'Current' : 'Applied';
                statusContainer.appendChild(statusText);
            } else if (isUnlocked) { // Unlocked but not applied/current
                btnContainer.style.display = 'flex';
                btnContainer.innerHTML = ''; // Clear purchase buttons
                // CSS now handles alignment (center for lang, right for theme)

                const actionBtn = document.createElement('button');
                actionBtn.classList.add('appstore-purchase-btn');

                if (isLanguageItem) { // Language item
                    actionBtn.classList.add('select-language-btn');
                    actionBtn.textContent = 'Select';
                    actionBtn.onclick = () => handleLanguageSelect(itemIdentifier.replace('lang-', ''));
                } else if (itemIdentifier === 'change-font') { // Font feature item
                    btnContainer.style.justifyContent = 'flex-end'; // Override to right-align single button
                    actionBtn.classList.add('customize-font-btn');
                    actionBtn.textContent = 'Customize';
                    actionBtn.onclick = () => {
                        hideModal(themeStoreModal); // Close store
                        populateCustomThemeModal(); // Open customizer
                    };
                } else { // Theme item
                    actionBtn.classList.add('apply-theme-btn');
                    actionBtn.textContent = 'Apply';
                    if (itemIdentifier === 'custom-theme') {
                        actionBtn.onclick = () => populateCustomThemeModal(); // Open customizer
                    } else {
                        actionBtn.onclick = () => applyTheme(itemIdentifier); // Apply directly
                    }
                }
                btnContainer.appendChild(actionBtn);
                actionBtn.style.display = 'inline-flex';
            } else { // Locked item
                btnContainer.style.display = 'flex';
                btnContainer.innerHTML = ''; // Clear potential old Apply/Select/Customize button
                // CSS now handles alignment (center for lang, right for theme)

                let starPriceAttr = '0';
                let moneyPriceAttr = null;
                let isFeature = false;

                // --- Get prices reliably ---
                if (isLanguageItem) { // Language
                    const langId = itemIdentifier.replace('lang-', '');
                    const langData = availableLanguages.find(l => l.id === langId);
                    if (langData) {
                        starPriceAttr = langData.priceStars.toString();
                        moneyPriceAttr = langData.priceMoney; // String or null
                    }
                } else { // Theme store item (Theme or Feature)
                    starPriceAttr = itemElement.dataset.starPrice || '0'; // Read from item div
                    moneyPriceAttr = itemElement.dataset.moneyPrice || null; // Read from item div
                    isFeature = itemIdentifier === 'change-font';
                }
                // --- End Get prices ---

                // Re-create Stars button
                const newStarsBtn = document.createElement('button');
                newStarsBtn.dataset.type = 'stars';
                newStarsBtn.dataset.price = starPriceAttr;
                newStarsBtn.innerHTML = `<span class="star-icon">★</span>${starPriceAttr}`;
                newStarsBtn.classList.add('appstore-purchase-btn');
                btnContainer.appendChild(newStarsBtn);
                newStarsBtn.style.display = 'inline-flex';
                newStarsBtn.disabled = starCount < parseInt(starPriceAttr);

                // Re-create Money button only if applicable
                if (moneyPriceAttr !== null) {
                    const newMoneyBtn = document.createElement('button');
                    newMoneyBtn.dataset.type = 'money';
                    newMoneyBtn.dataset.moneyPrice = moneyPriceAttr; // Store raw value
                    newMoneyBtn.textContent = `$${moneyPriceAttr}`; // Display with $
                    newMoneyBtn.classList.add('appstore-purchase-btn');
                    btnContainer.appendChild(newMoneyBtn);
                    newMoneyBtn.style.display = 'inline-flex';
                    newMoneyBtn.disabled = false; // Assuming real money purchase always enabled
                }

                // Ensure single button items are right aligned in themes
                if (!isLanguageItem && (isFeature || moneyPriceAttr === null)) {
                    btnContainer.style.justifyContent = 'flex-end';
                }
            }
        }


        // --- Theme Store Logic ---
        // (No major changes needed in updateStoreButtons or the event listener logic)
        function updateStoreButtons() {
            const currentThemeId = sessionStorage.getItem('chimCodeTheme') || 'default';
            themeStoreModal.querySelectorAll('.theme-item').forEach(item => {
                const itemIdentifier = item.dataset.itemIdentifier;
                if (!itemIdentifier) return;

                if (itemIdentifier === 'buy-stars') {
                    const btnContainer = item.querySelector('.purchase-buttons-container');
                    const buyBtn = btnContainer?.querySelector('button[data-action="buy-stars"]');
                    if(btnContainer) btnContainer.style.justifyContent = 'flex-end'; // Ensure right-align
                    if(buyBtn) buyBtn.disabled = false;
                    return;
                }

                const isApplied = currentThemeId === itemIdentifier;
                const isUnlocked = itemIdentifier === 'default' ||
                                unlockedThemes[itemIdentifier] === true ||
                                unlockedFeatures[itemIdentifier] === true;

                manageItemState(item, isUnlocked, isApplied);
            });
        }
        themeStoreContent.addEventListener('click', (event) => {
            const button = event.target.closest('.appstore-purchase-btn');
            if (!button || button.disabled ||
                button.classList.contains('apply-theme-btn') ||
                button.classList.contains('select-language-btn') ||
                button.classList.contains('customize-font-btn') ||
                button.closest('[data-item-identifier="default"]')) {
                return;
            }
            const itemElement = button.closest('.theme-item');
            const itemIdentifier = itemElement.dataset.itemIdentifier;
            const storeMessage = document.getElementById('store-message');
            storeMessage.textContent = '';
            if (button.dataset.action === 'buy-stars') {
                const amount = parseInt(button.dataset.amount);
                const moneyPrice = button.dataset.moneyPrice;
                console.log(`Simulating purchase of ${amount} stars for $${moneyPrice}`);
                starCount += amount;
                updateStarDisplay(true, 'gain'); // Update display
                saveStarCount(); // Save explicitly after purchase
                storeMessage.textContent = `${amount} stars added!`;
                storeMessage.style.color = 'var(--hint-color)';
                setTimeout(() => { storeMessage.textContent = ''; }, 4000);
                return;
            }
            const itemName = itemElement.querySelector('.theme-name').textContent;
            const purchaseType = button.dataset.type;
            const starPrice = parseInt(button.dataset.price);
            const moneyPrice = button.dataset.moneyPrice;
            let purchased = false;
            let unlockTarget = null;
            let storageKey = null;
            if (itemIdentifier === 'change-font') {
                unlockTarget = unlockedFeatures;
                storageKey = 'chimCodeUnlockedFeatures';
            } else {
                unlockTarget = unlockedThemes;
                storageKey = 'chimCodeUnlockedThemes';
            }
            if (purchaseType === 'stars') {
                if (starCount >= starPrice) {
                    previousStarCountForAnimation = starCount;
                    starCount -= starPrice;
                    unlockTarget[itemIdentifier] = true;
                    sessionStorage.setItem(storageKey, JSON.stringify(unlockTarget));
                    updateStarDisplay(true, 'loss'); // Update display
                    saveStarCount(); // Save explicitly after purchase
                    storeMessage.textContent = `${itemName} unlocked with stars!`;
                    storeMessage.style.color = 'var(--hint-color)';
                    purchased = true;
                } else {
                    storeMessage.textContent = `Insufficient stars! You need ${starPrice}.`;
                    storeMessage.style.color = 'var(--error-color)';
                }
            } else if (purchaseType === 'money') {
                console.log(`Simulating purchase of ${itemName} for $${moneyPrice}`);
                unlockTarget[itemIdentifier] = true;
                sessionStorage.setItem(storageKey, JSON.stringify(unlockTarget));
                storeMessage.textContent = `${itemName} purchased! (Simulated)`;
                storeMessage.style.color = 'var(--hint-color)';
                purchased = true;
            }
            if (purchased) {
                if (itemIdentifier === 'custom-theme' || itemIdentifier === 'change-font') {
                    manageItemState(itemElement, true, false);
                } else {
                    applyTheme(itemIdentifier);
                    manageItemState(itemElement, true, true);
                }
                updateStoreButtons(); // Update all buttons
            }
            setTimeout(() => { storeMessage.textContent = ''; }, 4000);
        });


        // --- Library Logic ---
        // (MODIFIED - CSS now handles alignment)
        function populateLibraryGrid() {
            libraryGrid.innerHTML = ''; // Clear previous content
            const currentLangId = 'c'; // Hardcoded

            availableLanguages.forEach(lang => {
                const langIdentifier = `lang-${lang.id}`; // Unique ID for storage
                const card = document.createElement('div');
                card.classList.add('language-card');
                card.dataset.itemIdentifier = langIdentifier;
                if (lang.id === currentLangId) {
                    card.classList.add('current-language');
                }
                const name = document.createElement('div');
                name.classList.add('language-name');
                name.textContent = lang.name;
                card.appendChild(name);
                const btnContainer = document.createElement('div');
                btnContainer.classList.add('purchase-buttons-container');
                card.appendChild(btnContainer);
                const statusContainer = document.createElement('div');
                statusContainer.classList.add('status-text-container');
                statusContainer.style.display = 'none'; // Hide initially
                card.appendChild(statusContainer);
                libraryGrid.appendChild(card);
            });
            updateLibraryButtons(); // Set initial state for all cards
        }
        function updateLibraryButtons() {
            const currentLangId = 'c'; // Hardcoded
            libraryGrid.querySelectorAll('.language-card').forEach(card => {
                const langIdentifier = card.dataset.itemIdentifier;
                const langId = langIdentifier.replace('lang-', '');
                const isCurrent = langId === currentLangId;
                const isUnlocked = unlockedLanguages[langIdentifier] === true || isCurrent; // C is always unlocked
                manageItemState(card, isUnlocked, isCurrent, isCurrent); // Pass isCurrent flag
            });
        }
        libraryModalContent.addEventListener('click', (event) => {
            const button = event.target.closest('.appstore-purchase-btn');
            if (!button || button.disabled || button.classList.contains('select-language-btn')) return;
            const cardElement = button.closest('.language-card');
            const langIdentifier = cardElement.dataset.itemIdentifier;
            const langName = cardElement.querySelector('.language-name').textContent;
            const purchaseType = button.dataset.type;
            const starPrice = parseInt(button.dataset.price);
            const moneyPrice = button.dataset.moneyPrice;
            const libraryMessage = document.getElementById('library-message');
            libraryMessage.textContent = '';
            let purchased = false;
            if (purchaseType === 'stars') {
                if (starCount >= starPrice) {
                    previousStarCountForAnimation = starCount;
                    starCount -= starPrice;
                    unlockedLanguages[langIdentifier] = true;
                    sessionStorage.setItem('chimCodeUnlockedLanguages', JSON.stringify(unlockedLanguages));
                    updateStarDisplay(true, 'loss'); // Update display
                    saveStarCount(); // Save explicitly
                    libraryMessage.textContent = `${langName} unlocked with stars!`;
                    libraryMessage.style.color = 'var(--hint-color)';
                    purchased = true;
                } else {
                    libraryMessage.textContent = `Insufficient stars! You need ${starPrice}.`;
                    libraryMessage.style.color = 'var(--error-color)';
                }
            } else if (purchaseType === 'money') {
                console.log(`Simulating purchase of ${langName} for $${moneyPrice}`);
                unlockedLanguages[langIdentifier] = true;
                sessionStorage.setItem('chimCodeUnlockedLanguages', JSON.stringify(unlockedLanguages));
                libraryMessage.textContent = `${langName} purchased! (Simulated)`;
                libraryMessage.style.color = 'var(--hint-color)';
                purchased = true;
            }
            if(purchased) {
                manageItemState(cardElement, true, false, false);
                updateLibraryButtons();
            }
            setTimeout(() => { libraryMessage.textContent = ''; }, 4000);
        });
        function handleLanguageSelect(langId) { // Called by select button's onclick
            console.log(`Switching to language: ${langId} (Not Implemented)`);
            libraryMessage.textContent = `Switching to ${langId.toUpperCase()} is not yet implemented.`;
            libraryMessage.style.color = 'var(--text-muted-color)';
            setTimeout(() => { libraryMessage.textContent = ''; }, 3000);
        }

        // --- Level Selection Logic ---
        // MODIFIED: Handle star reset when selecting the *same* level again
        function populateLevelList() {
            levelListContainer.innerHTML = ''; // Clear previous list
            challengesData.forEach((level, index) => { // Assumes challengesData is loaded
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('level-select-item');
                const button = document.createElement('button');
                button.classList.add('level-select-btn');
                button.dataset.levelIndex = index;
                const title = `Level ${index + 1}: ${level.goal.split('.')[0]}`;
                const concepts = level.concepts || 'Core concepts';
                button.innerHTML = `${title} <span>Concepts: ${escapeHtml(concepts)}</span>`;
                button.disabled = false; // Allow selecting any level

                button.addEventListener('click', () => {
                    const selectedLevelIndex = parseInt(button.dataset.levelIndex);
                    hideModal(levelSelectModal);

                    // Check if selecting the *same* level that was just completed or in progress
                    if (selectedLevelIndex === currentLevelIndex && !levelInProgress) {
                        // Revert stars from the last completed attempt of this level
                        let starChange = starCount - initialStarsForLevelAttempt;
                        console.log(`Re-selecting Level ${currentLevelIndex + 1}. Initial stars for last attempt: ${initialStarsForLevelAttempt}, Current stars: ${starCount}, Change: ${starChange}`);
                        starCount = initialStarsForLevelAttempt; // Revert
                        console.log(`Reverted star count to: ${starCount}`);
                        updateStarDisplay();
                        saveStarCount(); // Save reverted count
                    }
                    // If selecting a different level, the current starCount (from last save point) is fine

                    initializeGame(selectedLevelIndex); // Start the selected level
                });

                if (index === currentLevelIndex) {
                    button.style.borderColor = 'var(--accent-color)'; // Highlight current level
                }
                itemDiv.appendChild(button);
                levelListContainer.appendChild(itemDiv);
            });
            // Message for all levels complete remains the same
            if (currentLevelIndex >= challengesData.length && challengesData.length > 0) { // Check if current index is beyond last level
                const allComplete = document.createElement('div');
                allComplete.classList.add('level-select-item', 'text-center', 'font-bold');
                allComplete.style.color = 'var(--success-color)';
                allComplete.textContent = `All C levels complete!`;
                levelListContainer.appendChild(allComplete);
            }
        }


        // --- MODIFIED: Initialization ---
        function initializeGame(levelIndex = 0) {
            // --- Star Revert Logic (for restart/reselect) is handled BEFORE calling initializeGame ---

            currentLevelIndex = levelIndex;
            // Ensure challengesData is loaded before trying to access it
            if (typeof challengesData === 'undefined' || !challengesData || !challengesData[currentLevelIndex]) {
                console.error("Attempted to initialize invalid level or challengesData not loaded:", levelIndex);
                // Try to load level 0 as a fallback if currentLevelIndex is bad but challengesData exists
                if (typeof challengesData !== 'undefined' && challengesData && challengesData[0]) {
                    currentLevelIndex = 0;
                } else {
                    // If challengesData itself is missing or level 0 is also bad, show fatal error
                    interactionArea.innerHTML = `<p class="md:col-span-3 text-center text-red-500">FATAL ERROR: No level data found. Please ensure c_levels.js is loaded correctly.</p>`;
                    hintText.textContent = ''; revealHintBtn.classList.add('hidden'); return;
                }
            }

            const currentChallenge = challengesData[currentLevelIndex];
            currentStep = 0;

            // --- Attempt & Star Tracking ---
            initialStarsForLevelAttempt = starCount; // Store star count BEFORE this attempt begins
            levelAttempts[currentLevelIndex] = (levelAttempts[currentLevelIndex] || 0) + 1; // Increment attempt count
            levelInProgress = true; // Mark level as in progress

            // Save initial state for potential refresh recovery
            sessionStorage.setItem('chimCodeLevelInProgress', 'true');
            sessionStorage.setItem('chimCodeInitialStars', initialStarsForLevelAttempt.toString());
            sessionStorage.setItem('chimCodeSavedLevelIndex', currentLevelIndex.toString());
            sessionStorage.setItem('chimCodeLevelAttempts', JSON.stringify(levelAttempts)); // Save attempts count
            // Do NOT save starCount itself here
            console.log(`Initializing Level ${currentLevelIndex + 1}, Attempt ${levelAttempts[currentLevelIndex]}. Initial stars: ${initialStarsForLevelAttempt}`);
            // --- End Tracking ---


            constructedCode = `// Goal: ${escapeHtml(currentChallenge.goal)}\n\n`;
            codeDisplayArea.innerHTML = constructedCode;
            levelTextSpan.textContent = `Level ${currentLevelIndex + 1}`;
            attemptsCounter.textContent = `Attempts: ${levelAttempts[currentLevelIndex]}`; // Update attempts display
            updateStarDisplay(); // Update star display (but doesn't save)
            hintContainer.style.display = 'flex';
            displayStep(); // Display first step options and hint
        }

        // --- Start the Game ---
        const startLevelIndex = loadSessionData(); // Load saved state, handles potential refresh revert
        // Ensure challengesData is available before initializing the game
        if (typeof challengesData !== 'undefined' && challengesData) {
            initializeGame(startLevelIndex); // Start game at the determined level
        } else {
            // This case should ideally be caught by the check in initializeGame,
            // but as a fallback:
            console.error("FATAL: challengesData not defined. Game cannot start.");
            document.body.innerHTML = `<p style="color:red; font-size:1.5em; text-align:center; padding-top: 20px;">Error: Game levels (challengesData) could not be loaded. Please check that 'c_levels.js' is present and correctly linked.</p>`;
        }

    </script>

</body>
</html>